{% extends 'base.html' %}

{% block extra_css %}
<style>
    /* --- General Layout --- */
    .front-page-container {
        max-width: 1800px;
        margin: 0 auto;
        padding-bottom: 80px;
    }

    /* --- Animations --- */
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideInLeft {
        from { opacity: 0; transform: translateX(-50px); }
        to { opacity: 1; transform: translateX(0); }
    }

    @keyframes slideInRight {
        from { opacity: 0; transform: translateX(50px); }
        to { opacity: 1; transform: translateX(0); }
    }

    @keyframes zoomIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }

    /* Floating Animation for Background Elements */
    @keyframes float {
        0% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(5deg); }
        100% { transform: translateY(0px) rotate(0deg); }
    }

    /* --- Hero Slideshow (Redesigned) --- */
    .hero-section {
        position: relative;
        width: 100%;
        height: 600px; /* Fixed height for consistency */
        margin-bottom: 50px;
        
        /* Cool Modern Background - Enhanced Gradient */
        background: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
        /* Optional subtle pattern overlay */
        background-image: 
            radial-gradient(at 0% 0%, rgba(255, 237, 240, 0.6) 0px, transparent 50%),
            radial-gradient(at 100% 0%, rgba(235, 245, 255, 0.6) 0px, transparent 50%),
            radial-gradient(at 100% 100%, rgba(255, 245, 235, 0.4) 0px, transparent 50%);
        
        border-radius: 0 0 40px 40px; /* Softer curve */
        box-shadow: 0 20px 60px -10px rgba(0,0,0,0.08); /* Sophisticated shadow */
        overflow: hidden;
    }

    /* Decorative Abstract Blobs for "Cool" effect - Animated */
    .hero-section::before {
        content: '';
        position: absolute;
        top: -100px; right: -50px;
        width: 600px; height: 600px;
        background: linear-gradient(45deg, rgba(255, 56, 92, 0.06), rgba(255, 100, 130, 0.06));
        border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
        z-index: 0;
        pointer-events: none;
        animation: float 8s ease-in-out infinite;
    }

    .hero-section::after {
        content: '';
        position: absolute;
        bottom: -120px; left: -80px;
        width: 500px; height: 500px;
        background: linear-gradient(45deg, rgba(64, 158, 255, 0.08), rgba(100, 200, 255, 0.08));
        border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
        z-index: 0;
        pointer-events: none;
        animation: float 10s ease-in-out infinite reverse;
    }

    .slide {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 100px; /* More breathing room */
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        gap: 60px;
        z-index: 1; /* Sit above the background blobs */
    }

    .slide.active { 
        opacity: 1; 
        pointer-events: auto;
    }

    /* Column 1: Image (Left) */
    .slide-img-col {
        flex: 1.3;
        height: 85%;
        display: flex;
        align-items: center;
        justify-content: center; /* Center image in its box */
        opacity: 0;
        perspective: 1000px; /* For 3D feel */
    }
    
    .slide-img {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        object-fit: contain;
        border-radius: 24px;
        /* Refined shadow */
        box-shadow: 
            0 20px 40px rgba(0,0,0,0.1),
            0 10px 15px rgba(0,0,0,0.05); 
        transform: translateX(-60px) rotateY(10deg);
        transition: transform 0.9s cubic-bezier(0.2, 0.8, 0.2, 1);
        background: white; /* Fallback background for transparent PNGs */
    }

    /* Column 2: Details (Middle) */
    .slide-details-col {
        flex: 1;
        text-align: left;
        color: var(--dark);
        opacity: 0;
        transform: translateY(30px);
    }

    .slide-details-col h1 {
        font-size: 3.5rem; /* Larger Title */
        font-weight: 800;
        margin-bottom: 20px;
        line-height: 1.1;
        color: var(--dark);
        letter-spacing: -1px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.05); /* Very subtle text shadow */
    }

    .slide-details-col p.location {
        font-size: 1.3rem;
        color: var(--gray);
        font-weight: 500;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .slide-details-col p.location i { color: var(--primary); }

    .slide-details-col .price-tag {
        font-size: 1.2rem; 
        margin-top: 20px;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(5px);
        padding: 10px 20px;
        border-radius: 12px;
        display: inline-block;
        border: 1px solid rgba(0,0,0,0.05);
    }

    /* Column 3: Action (Right) */
    .slide-action-col {
        flex: 0.6;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        opacity: 0;
        transform: translateX(60px);
    }

    /* --- Animation Activators --- */
    .slide.active .slide-img-col {
        opacity: 1;
        animation: fadeIn 0.9s ease-out forwards;
    }
    .slide.active .slide-img {
        transform: translateX(0) rotateY(0deg);
        animation: slideInLeft 0.9s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    }

    .slide.active .slide-details-col {
        opacity: 1;
        transform: translateY(0);
        transition: all 0.9s cubic-bezier(0.2, 0.8, 0.2, 1) 0.2s; /* Smoother easing */
    }

    .slide.active .slide-action-col {
        opacity: 1;
        transform: translateX(0);
        transition: all 0.9s cubic-bezier(0.2, 0.8, 0.2, 1) 0.4s;
    }

    /* Refined Button */
    .slide-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: var(--dark);
        color: white;
        padding: 22px 48px;
        border-radius: 50px; /* Pill shape */
        font-weight: 700;
        font-size: 1.15rem;
        text-decoration: none;
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        white-space: nowrap;
        position: relative;
        overflow: hidden;
    }
    
    .slide-btn:hover { 
        transform: translateY(-3px) scale(1.02); 
        background: var(--primary);
        box-shadow: 0 20px 35px rgba(255, 56, 92, 0.35);
    }
    .slide-btn i { margin-left: 12px; transition: transform 0.3s; }
    .slide-btn:hover i { transform: translateX(5px); }

    /* --- Hero Navigation Buttons --- */
    .hero-nav-btn {
        position: absolute;
        bottom: 40px; 
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(0,0,0,0.05);
        box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        font-size: 20px;
        color: var(--dark);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    .hero-nav-btn:hover {
        background: var(--primary);
        color: white;
        transform: scale(1.15) rotate(0deg);
        box-shadow: 0 12px 25px rgba(255, 56, 92, 0.3);
        border-color: transparent;
    }

    .hero-nav-btn.prev { right: 120px; left: auto; }
    .hero-nav-btn.next { right: 40px; left: auto; }


    /* --- Section Headers --- */
    .section-header {
        padding: 0 60px; /* Increased padding */
        margin-bottom: 24px;
        margin-top: 60px;
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
    }
    .section-header h2 { font-size: 28px; font-weight: 800; color: var(--dark); letter-spacing: -0.5px; }
    .section-header p { font-size: 16px; color: var(--gray); margin-top: 6px; }
    
    /* --- Scrollable Section Wrapper & Buttons --- */
    .scroll-wrapper {
        position: relative;
        padding: 0 80px; /* Increased padding to prevent overlap */
        opacity: 0;
        animation: fadeInUp 0.8s ease-out 0.5s forwards;
    }

    .horizontal-scroll {
        display: flex;
        gap: 24px;
        padding: 10px 4px 30px;
        overflow-x: auto;
        scroll-behavior: smooth;
        scrollbar-width: none;
    }
    .horizontal-scroll::-webkit-scrollbar { display: none; }

    /* Navigation Buttons (Left/Right) for Lists */
    .nav-btn {
        position: absolute;
        top: 45%; /* Slightly higher */
        transform: translateY(-50%);
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: white;
        border: 1px solid rgba(0,0,0,0.08);
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        opacity: 0;
        pointer-events: none;
    }
    
    .scroll-wrapper:hover .nav-btn {
        opacity: 1;
        pointer-events: auto;
    }
    
    .nav-btn:hover {
        transform: translateY(-50%) scale(1.15);
        box-shadow: 0 8px 24px rgba(0,0,0,0.18);
        background: var(--dark);
        color: white;
        border-color: var(--dark);
    }
    
    /* Position buttons outside the content area (inside the padding gutter) */
    .nav-btn.prev { left: 20px; }
    .nav-btn.next { right: 20px; }

    .nav-btn i { font-size: 16px; }

    .scroll-card {
        min-width: 320px;
        max-width: 320px;
        flex-shrink: 0;
        transition: transform 0.3s ease;
    }
    .scroll-card:hover { transform: translateY(-8px); }

    /* --- Categories (Glassmorphism) --- */
    .categories {
        display: flex; gap: 40px; padding: 20px 60px;
        overflow-x: auto; scrollbar-width: none; border-bottom: 1px solid rgba(0,0,0,0.06);
        position: sticky; top: 80px; 
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        z-index: 90;
        margin-bottom: 20px;
    }
    .categories::-webkit-scrollbar { display: none; }
    
    .category-item {
        display: flex; flex-direction: column; align-items: center; gap: 10px;
        min-width: 64px; cursor: pointer; opacity: 0.5; transition: all 0.3s;
        border-bottom: 2px solid transparent; padding-bottom: 10px;
        text-decoration: none; color: var(--gray);
    }
    .category-item:hover, .category-item.active { opacity: 1; transform: scale(1.1); color: var(--dark); }
    .category-item.active { border-bottom-color: var(--dark); }
    .category-item i { font-size: 24px; margin-bottom: 4px; }
    .category-item span { font-size: 13px; font-weight: 600; white-space: nowrap; }
    
    /* --- Standard Grid (All Listings) --- */
    .listings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 40px 24px;
        padding: 24px 60px; /* Increased padding */
        opacity: 0;
        animation: fadeInUp 0.8s ease-out 0.8s forwards;
    }

    /* --- Card Styles --- */
    .card { cursor: pointer; text-decoration: none; color: inherit; display: block; position: relative; }
    
    .image-container {
        position: relative; aspect-ratio: 20/19; border-radius: 16px;
        overflow: hidden; background: #f0f0f0; margin-bottom: 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    
    .card-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
    .card:hover .card-img { transform: scale(1.12); }

    .favorite-btn {
        position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.85);
        backdrop-filter: blur(4px);
        border: none; color: rgba(0, 0, 0, 0.5); font-size: 20px; z-index: 10; cursor: pointer;
        transition: all 0.2s; -webkit-text-stroke: 1px white;
        display: flex; align-items: center; justify-content: center;
        width: 36px; height: 36px; border-radius: 50%;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .favorite-btn:hover { transform: scale(1.15); background: white; color: var(--primary); }
    .favorite-btn.liked { color: #ff385c; opacity: 1; -webkit-text-stroke: 0; background: white; }
    
    .card-info h3 { font-size: 16px; font-weight: 700; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--dark); }
    .card-info p { font-size: 15px; color: var(--gray); margin-bottom: 6px; }
    .price { margin-top: 8px; font-size: 17px; font-weight: 800; color: var(--dark); }
    .price span { font-weight: 400; color: var(--gray); font-size: 15px; }

    /* Animation Keyframes for Heart */
    @keyframes heart-bounce { 0% { transform: scale(1); } 40% { transform: scale(1.6); } 70% { transform: scale(0.85); } 100% { transform: scale(1); } }
    .favorite-btn.animating i { animation: heart-bounce 0.45s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

    @media (max-width: 1024px) {
        .hero-section { height: auto; padding: 60px 0; border-radius: 0 0 24px 24px; }
        .slide { flex-direction: column; text-align: center; padding: 0 24px; gap: 30px; position: relative; display: none; opacity: 1; }
        .slide.active { display: flex; }
        
        .slide-img-col { width: 100%; height: 320px; margin-bottom: 10px; flex: initial; transform: none !important; perspective: none; }
        .slide-img { max-height: 100%; width: auto; transform: none !important; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        .slide-details-col { text-align: center; width: 100%; transform: none !important; flex: initial; }
        .slide-details-col h1 { font-size: 2.5rem; margin-bottom: 12px; }
        .slide-details-col p.location { justify-content: center; font-size: 1.1rem; }
        
        .slide-action-col { width: 100%; justify-content: center; margin-top: 10px; transform: none !important; flex: initial; }
        
        .hero-nav-btn { bottom: 20px; width: 48px; height: 48px; font-size: 16px; }
        .hero-nav-btn.prev { left: 50%; right: auto; margin-left: -60px; }
        .hero-nav-btn.next { right: 50%; left: auto; margin-right: -60px; }
    }
    
    @media (max-width: 768px) {
        .section-header, .scroll-wrapper, .listings-grid, .categories { padding-left: 24px; padding-right: 24px; }
        .nav-btn { display: none; } /* Hide list nav buttons on mobile */
        .hero-section { height: auto; padding-bottom: 80px; }
    }
</style>
{% endblock %}

{% block content %}
<div class="front-page-container">

    <!-- 1. HERO SLIDESHOW (Redesigned) -->
    {% if not search_query and not filter_type and featured_rooms %}
    <div class="hero-section">
        {% for room in featured_rooms %}
        <div class="slide {% if loop.first %}active{% endif %}">
            
            <!-- Left: Image (Original size constrained) -->
            <div class="slide-img-col">
                <img src="{{ room.image_url }}" class="slide-img" onerror="this.src='https://via.placeholder.com/800x600'">
            </div>

            <!-- Middle: Details -->
            <div class="slide-details-col">
                <h1>{{ room.title }}</h1>
                <p class="location"><i class="fas fa-map-marker-alt"></i> {{ room.address.split(',')[0] if ',' in room.address else room.address }}</p>
                <div class="price-tag">
                    Starting at <span style="color:var(--primary); font-weight:800; font-size:1.1em;">${{ room.price_per_month }}</span><span style="color:var(--gray); font-size:0.9em;">/month</span>
                </div>
            </div>

            <!-- Right: Action -->
            <div class="slide-action-col">
                <a href="/room/{{ room.id }}" class="slide-btn">
                    Explore Now <i class="fas fa-arrow-right"></i>
                </a>
            </div>

        </div>
        {% endfor %}

        <!-- Navigation Buttons (Moved to bottom right in CSS) -->
        <button class="hero-nav-btn prev" onclick="changeSlide(-1)"><i class="fas fa-chevron-left"></i></button>
        <button class="hero-nav-btn next" onclick="changeSlide(1)"><i class="fas fa-chevron-right"></i></button>
    </div>
    {% endif %}

    <!-- 2. CATEGORIES (Sticky) -->
    <div class="categories">
        <a href="/" class="category-item {{ 'active' if not search_query and not filter_type else '' }}">
            <i class="fas fa-th-large"></i><span>All</span>
        </a>
        
        <!-- Near Me triggers the geolocation script from base.html -->
        <div class="category-item" onclick="detectLocation()">
            <i class="fas fa-map-marked-alt"></i><span>Near Me</span>
        </div>

        <a href="/?filter=trending" class="category-item {{ 'active' if filter_type == 'trending' else '' }}">
            <i class="fas fa-fire"></i><span>Trending</span>
        </a>
        
        <!-- Simple text-based filters for other categories -->
        <a href="/?q=room" class="category-item">
            <i class="fas fa-home"></i><span>Rooms</span>
        </a>
        <a href="/?q=apartment" class="category-item">
            <i class="fas fa-city"></i><span>Apartments</span>
        </a>
        <a href="/?q=beach" class="category-item">
            <i class="fas fa-umbrella-beach"></i><span>Beach</span>
        </a>
        <a href="/?q=cabin" class="category-item">
            <i class="fas fa-tree"></i><span>Cabins</span>
        </a>
    </div>

    <!-- Search Feedback & No Results Logic -->
    {% if search_query %}
    <div style="padding: 20px 60px;">
        {% if rooms %}
            <h2>Results for "{{ search_query }}"</h2>
        {% else %}
            <div style="padding: 20px 0;">
                <h2>No results found for "{{ search_query }}"</h2>
                <p style="color: var(--gray); font-size: 16px; margin-top: 8px;">We couldn't find any rooms in that location. Check out these popular places instead:</p>
            </div>
        {% endif %}
    </div>
    {% elif filter_type == 'trending' %}
    <div style="padding: 0 60px; margin-top: 20px;">
        <h2>Trending Homes</h2>
        <p style="color: var(--gray);">Most popular properties right now.</p>
    </div>
    {% endif %}


    <!-- 3. RECENTLY VIEWED (Horizontal Scroll) - Hide if filtering -->
    {% if recently_viewed_rooms and not search_query and not filter_type %}
    <div class="section-header">
        <div>
            <h2>Recently Viewed</h2>
            <p>Pick up where you left off</p>
        </div>
    </div>
    <div class="scroll-wrapper" id="recent-wrapper">
        <button class="nav-btn prev" onclick="scrollSection('recent-wrapper', -1)"><i class="fas fa-chevron-left"></i></button>
        <div class="horizontal-scroll">
            {% for room in recently_viewed_rooms %}
            <div class="scroll-card">
                <a href="/room/{{ room.id }}" class="card">
                    <div class="image-container">
                        <button class="favorite-btn {% if room.id in liked_room_ids %}liked{% endif %}" onclick="toggleLike(event, {{ room.id }})">
                            <i class="fas fa-heart"></i>
                        </button>
                        <img src="{{ room.image_url }}" class="card-img" onerror="this.src='https://via.placeholder.com/600x600'">
                    </div>
                    <div class="card-info">
                        <h3>{{ room.address }}</h3>
                        <p>{{ room.title }}</p>
                        <div class="price">${{ room.price_per_month }} <span>month</span></div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
        <button class="nav-btn next" onclick="scrollSection('recent-wrapper', 1)"><i class="fas fa-chevron-right"></i></button>
    </div>
    {% endif %}


    <!-- 4. RECOMMENDED / LOCATION BASED (Horizontal Scroll) -->
    <!-- Modified logic: Show if search/filter is empty OR if search matches nothing (so we show fallback) -->
    {% if recommended_rooms and (not search_query or not rooms) and not filter_type %}
    <div class="section-header">
        <div>
            <h2>Find your place to live</h2>
            <p>Popular homes recommended for you</p>
        </div>
    </div>
    <div class="scroll-wrapper" id="recommend-wrapper">
        <button class="nav-btn prev" onclick="scrollSection('recommend-wrapper', -1)"><i class="fas fa-chevron-left"></i></button>
        <div class="horizontal-scroll">
            {% for room in recommended_rooms %}
            <div class="scroll-card">
                <a href="/room/{{ room.id }}" class="card">
                    <div class="image-container">
                        <button class="favorite-btn {% if room.id in liked_room_ids %}liked{% endif %}" onclick="toggleLike(event, {{ room.id }})">
                            <i class="fas fa-heart"></i>
                        </button>
                        <img src="{{ room.image_url }}" class="card-img" onerror="this.src='https://via.placeholder.com/600x600'">
                    </div>
                    <div class="card-info">
                        <h3>{{ room.address }}</h3>
                        <p>{{ room.title }}</p>
                        <div class="price">${{ room.price_per_month }} <span>month</span></div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
        <button class="nav-btn next" onclick="scrollSection('recommend-wrapper', 1)"><i class="fas fa-chevron-right"></i></button>
    </div>
    {% endif %}


    <!-- 5. ALL LISTINGS GRID -->
    {% if rooms %}
    <div class="section-header">
        {% if not search_query and not filter_type %}
            <h2>Explore All</h2>
        {% endif %}
    </div>
    <div class="listings-grid">
        {% for room in rooms %}
        <a href="/room/{{ room.id }}" class="card">
            <div class="image-container">
                <button class="favorite-btn {% if room.id in liked_room_ids %}liked{% endif %}" onclick="toggleLike(event, {{ room.id }})">
                    <i class="fas fa-heart"></i>
                </button>
                <img src="{{ room.image_url }}" alt="{{ room.title }}" class="card-img" onerror="this.src='https://via.placeholder.com/600x600'">
            </div>
            
            <div class="card-info">
                <div style="display:flex; justify-content:space-between;">
                    <h3>{{ room.address }}</h3>
                </div>
                <p>{{ room.title }}</p>
                <div class="price">${{ room.price_per_month }} <span>month</span></div>
            </div>
        </a>
        {% endfor %}
    </div>
    {% elif not recommended_rooms %}
    <!-- Only show this if absolutely NO data (search empty, recommendations empty) -->
    <div style="text-align: center; padding: 50px;">
        <h3>No rooms available anywhere.</h3>
        <a href="/upload" class="btn-primary" style="display:inline-block; margin-top:20px;">Upload Now</a>
    </div>
    {% endif %}

</div>

<!-- JavaScript for Slideshow, Like Button & Scrolling -->
<script>
    // --- ADVANCED SLIDESHOW LOGIC ---
    let currentSlide = 0;
    const slides = document.querySelectorAll('.slide');
    const totalSlides = slides.length;
    let slideInterval;

    function startSlideShow() {
        if (totalSlides > 1) {
            slideInterval = setInterval(() => changeSlide(1, false), 5000);
        }
    }

    function changeSlide(direction, manual = true) {
        if (totalSlides <= 1) return;
        
        // Reset timer on manual click
        if (manual) {
            clearInterval(slideInterval);
            startSlideShow();
        }

        slides[currentSlide].classList.remove('active');
        
        // Calculate new index
        currentSlide = (currentSlide + direction + totalSlides) % totalSlides;
        
        slides[currentSlide].classList.add('active');
    }

    // Start auto-play
    startSlideShow();

    // --- HORIZONTAL SCROLL LOGIC ---
    function scrollSection(wrapperId, direction) {
        const wrapper = document.getElementById(wrapperId);
        const container = wrapper.querySelector('.horizontal-scroll');
        const scrollAmount = 350; // Card width + gap
        
        container.scrollBy({
            left: scrollAmount * direction,
            behavior: 'smooth'
        });
    }

    // --- LIKE BUTTON LOGIC ---
    async function toggleLike(event, roomId) {
        event.preventDefault();
        event.stopPropagation();
        
        const btn = event.currentTarget;
        const wasLiked = btn.classList.contains('liked');
        
        // Optimistic UI
        if (wasLiked) {
            btn.classList.remove('liked');
        } else {
            btn.classList.add('liked');
            btn.classList.remove('animating');
            void btn.offsetWidth; // Force Reflow
            btn.classList.add('animating');
        }

        try {
            const response = await fetch(`/toggle_wishlist/${roomId}`, { method: 'POST' });
            
            if (response.status === 401) {
                if (wasLiked) btn.classList.add('liked'); else btn.classList.remove('liked');
                alert("Please login to like properties!");
                window.location.href = "/login";
                return;
            }
        } catch (error) {
            console.error('Error toggling like:', error);
            if (wasLiked) btn.classList.add('liked'); else btn.classList.remove('liked');
        }
    }
</script>
{% endblock %}