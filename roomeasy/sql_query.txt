-- Create a table for Rooms
create table rooms (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  owner_id uuid references auth.users not null,
  title text not null,
  description text,
  address text not null,
  price_per_month numeric not null,
  image_url text not null, -- For this demo, we use a single main image URL
  status text default 'available'
);

-- Create a table for Bookings
create table bookings (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  user_id uuid references auth.users not null,
  room_id bigint references rooms(id) not null,
  booking_type text not null, -- 'lock', 'full', 'visit'
  amount_paid numeric not null
);



-- 1. Enable Row Level Security on your existing tables
ALTER TABLE rooms ENABLE ROW LEVEL SECURITY;
ALTER TABLE bookings ENABLE ROW LEVEL SECURITY;

-- 2. Policies for 'rooms' table
-- Allow anyone (logged in or not) to VIEW rooms
CREATE POLICY "Public rooms are viewable by everyone" 
ON rooms FOR SELECT 
USING ( true );

-- Allow only logged-in users to UPLOAD (Insert) rooms
-- The owner_id in the data must match the ID of the user currently logged in
CREATE POLICY "Users can upload their own rooms" 
ON rooms FOR INSERT 
WITH CHECK ( auth.uid() = owner_id );

-- Optional: Allow users to update only their own rooms
CREATE POLICY "Users can update their own rooms" 
ON rooms FOR UPDATE 
USING ( auth.uid() = owner_id );

-- 3. Policies for 'bookings' table
-- Allow users to CREATE a booking (Insert)
-- The user_id in the booking must match the logged-in user
CREATE POLICY "Users can create their own bookings" 
ON bookings FOR INSERT 
WITH CHECK ( auth.uid() = user_id );

-- Allow users to SEE only their own bookings (and potentially the room owner)
CREATE POLICY "Users can view their own bookings" 
ON bookings FOR SELECT 
USING ( auth.uid() = user_id );



-- 1. Create the Custom User Table (Profiles)
-- We use 'user_profiles' because 'user' is a reserved keyword in Postgres
create table public.user_profiles (
  id uuid references auth.users not null primary key,
  email text,
  full_name text,
  role text default 'user', -- can be 'user', 'admin', etc.
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2. Enable Row Level Security (RLS) for security
alter table public.user_profiles enable row level security;

-- Policy: Users can read their own profile
create policy "Users can view own profile" 
on public.user_profiles for select 
using ( auth.uid() = id );

-- Policy: Users can update their own profile
create policy "Users can update own profile" 
on public.user_profiles for update 
using ( auth.uid() = id );

-- 3. Create a Trigger to automatically add new signups to this table
-- This function runs every time a new user is created in Supabase Auth
create or replace function public.handle_new_user()
returns trigger as $$
begin
  insert into public.user_profiles (id, email, full_name, role)
  values (
    new.id, 
    new.email, 
    new.raw_user_meta_data->>'full_name', -- Extracts name from metadata passed during signup
    'user'
  );
  return new;
end;
$$ language plpgsql security definer;

-- Trigger definition
create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();

-- 4. Existing Rooms & Bookings Tables (Preserved from your code)
create table if not exists rooms (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  owner_id uuid references auth.users not null,
  title text not null,
  description text,
  address text not null,
  price_per_month numeric not null,
  image_url text not null,
  status text default 'available'
);

create table if not exists bookings (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  user_id uuid references auth.users not null,
  room_id bigint references rooms(id) not null,
  booking_type text not null,
  amount_paid numeric not null
);


-- 1. Reset (Drop tables if they exist to avoid conflicts)
drop table if exists bookings;
drop table if exists rooms;
drop table if exists user_profiles;

-- 2. Create the Custom User Table (Stores Password directly)
create table public.user_profiles (
  id uuid default gen_random_uuid() primary key,
  email text not null unique,
  password text not null, -- Storing password here directly
  full_name text,
  role text default 'user',
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 3. Create Rooms Table
create table public.rooms (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  owner_id uuid references public.user_profiles(id) not null, -- Link to our custom table
  title text not null,
  description text,
  address text not null,
  price_per_month numeric not null,
  image_url text not null,
  status text default 'available'
);

-- 4. Create Bookings Table
create table public.bookings (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  user_id uuid references public.user_profiles(id) not null, -- Link to our custom table
  room_id bigint references public.rooms(id) not null,
  booking_type text not null,
  amount_paid numeric not null
);

-- 5. IMPORTANT: Disable RLS (Row Level Security)
-- Since we are managing auth manually in Python, we need the API to have full access
alter table public.user_profiles disable row level security;
alter table public.rooms disable row level security;
alter table public.bookings disable row level security;

-- Run this to update your existing table
ALTER TABLE public.user_profiles ADD COLUMN IF NOT EXISTS profile_image_url text;

-- (Optional) If you haven't created the tables yet, use this full definition:
/*
create table public.user_profiles (
  id uuid default gen_random_uuid() primary key,
  email text not null unique,
  password text not null,
  full_name text,
  role text default 'user',
  profile_image_url text, -- New Column
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);
*/


-- 1. Create Wishlist Table
create table public.wishlist (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  user_id uuid references public.user_profiles(id) not null,
  room_id bigint references public.rooms(id) not null,
  unique(user_id, room_id) -- Prevents a user from liking the same room twice
);

-- 2. Disable RLS for easier access via API (since we handle auth in Python)
alter table public.wishlist disable row level security;

ALTER TABLE public.rooms ADD COLUMN IF NOT EXISTS amenities text[];

-- Run these commands in your Supabase SQL Editor to add the new columns

ALTER TABLE rooms ADD COLUMN IF NOT EXISTS state text;
ALTER TABLE rooms ADD COLUMN IF NOT EXISTS city text;
ALTER TABLE rooms ADD COLUMN IF NOT EXISTS nearby_location text;

-- Optional: If you want to backfill existing rows (simple logic)
-- UPDATE rooms SET state = 'Unknown', city = 'Unknown', nearby_location = address WHERE state IS NULL;